name: Release (Container + Debian)

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  set_env:
    name: Prepare release metadata
    runs-on: ubuntu-latest
    outputs:
      tags: ${{ steps.version_step.outputs.tags }}
      should_run: ${{ steps.version_step.outputs.should_run }}
    env:
      VERSION: ${{ github.ref_name }}
      SHA: ${{ github.sha }}
    steps:
      - id: version_step
        run: |
          set -Eeuo pipefail
          IFS=$'\n\t'

          if [[ "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-(alpha|beta|rc)(\.[0-9]+)?)?$ ]]; then
            echo "Valid version: $VERSION"
            echo "tags=latest,$VERSION,$SHA" >> "$GITHUB_OUTPUT"
            echo "should_run=true" >> "$GITHUB_OUTPUT"
          else
            echo "::warning ::Skipping release workflow because ref '$VERSION' is not a semantic version (vX.Y.Z)"
            echo "should_run=false" >> "$GITHUB_OUTPUT"
          fi

  container:
    name: Build, attest & push container
    needs: set_env
    if: needs.set_env.outputs.should_run == 'true'
    uses: ./.github/workflows/build-and-push-docker-hub.yaml
    with:
      image_name: zallet-test
      image_tags: ${{ needs.set_env.outputs.tags }}
      dockerfile: Dockerfile
      context: .
      build-args: ""
      platforms: linux/amd64
      oci-artifact-name: ${{ format('zallet-runtime-oci-{0}', github.run_id) }}
    secrets:
      dockerhub_username: ${{ secrets.DOCKERHUB_USERNAME }}
      dockerhub_password: ${{ secrets.DOCKERHUB_PASSWORD }}
      dockerhub_registry: ${{ secrets.DOCKERHUB_REGISTRY }}

  deb_release:
    name: Build Debian packages from exported binaries
    needs: [set_env, container]
    if: needs.set_env.outputs.should_run == 'true'
    uses: ./.github/workflows/deb-release.yml
    with:
      version: ${{ github.ref_name }}
      git-sha: ${{ github.sha }}
      oci-artifact-name: ${{ needs.container.outputs.oci-artifact-name }}
    secrets:
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      GCP_PROJECT_ID_PROD: ${{ secrets.GCP_PROJECT_ID_PROD }}
