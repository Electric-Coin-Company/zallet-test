name: Build, Attest & Sign Docker Image

on:
  workflow_call:
    inputs:
      image_name:
        description: "Docker image name (e.g. user/repo)"
        required: true
        type: string
      image_tags:
        description: "Comma-separated list of tags"
        required: true
        type: string
      dockerfile:
        description: "Path to the Dockerfile"
        required: true
        type: string
      context:
        description: "Build context"
        required: true
        type: string
      build-args:
        description: "Docker build args (one per line, optional)"
        required: true
        type: string
      oci-artifact-name:
        description: "Artifact name for the exported OCI runtime image"
        required: false
        default: zallet-runtime-oci
        type: string
    secrets:
      dockerhub_registry:
        required: true
        description: "Docker Hub registry (e.g. docker.io)"
      dockerhub_username:
        required: true
        description: "Docker Hub username"
      dockerhub_password:
        required: true
        description: "Docker Hub password"
  workflow_dispatch:
    inputs:
      image_name:
        description: "Docker image name (e.g. user/repo)"
        required: true
        type: string
      image_tags:
        description: "Comma-separated list of tags"
        required: true
        type: string
      dockerfile:
        description: "Path to the Dockerfile"
        required: true
        type: string
      context:
        description: "Build context"
        required: true
        type: string
      build-args:
        description: "Docker build args (one per line, optional)"
        required: true
        type: string
      oci-artifact-name:
        description: "Artifact name for the exported OCI runtime image"
        required: true
        type: string

permissions:
  id-token: write        # Needed for keyless signing with Cosign and checkout
  contents: read
  attestations: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      REGISTRY: ${{ secrets.dockerhub_registry }}
      IMAGE_NAME: ${{ inputs.image_name }}
      BUILD_ARGS_RAW: ${{ inputs['build-args'] }}
      OCI_ARTIFACT_NAME: ${{ inputs.oci-artifact-name }}
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-ref: ${{ steps.emit.outputs.image_ref }}
      oci-artifact-name: ${{ steps.emit.outputs.artifact_name }}
    steps:
      - name: Compute Docker image tags
        id: set-tags
        run: |
          set -euo pipefail
          TAGS="${{ inputs.image_tags }}"
          IFS=',' read -ra ELEMENTS <<< "$TAGS"
          TAGS_FIXED=""
          for ELEMENT in "${ELEMENTS[@]}"; do
            ELEMENT_TRIMMED="$(echo "$ELEMENT" | xargs)"
            [[ -z "$ELEMENT_TRIMMED" ]] && continue
            TAGS_FIXED+="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$ELEMENT_TRIMMED,"
          done
          TAGS_FIXED=${TAGS_FIXED%,}
          if [[ -z "$TAGS_FIXED" ]]; then
            echo "No valid tags were computed" >&2
            exit 1
          fi
          echo "tags_fixed=$TAGS_FIXED" >> "$GITHUB_ENV"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Enable containerd image store on Docker Engine
        run: |
          set -euo pipefail
          sudo mkdir -p /etc/docker
          sudo tee /etc/docker/daemon.json >/dev/null <<'EOF'
          {
            "features": {
              "containerd-snapshotter": true
            }
          }
          EOF
          sudo systemctl restart docker

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx (containerd image store)
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker
          driver-opts: |
            image-store=containerd

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.dockerhub_registry }}
          username: ${{ secrets.dockerhub_username }}
          password: ${{ secrets.dockerhub_password }}

      - name: Build & Push (SBOM + provenance)
        id: build
        uses: docker/build-push-action@v6
        with:
          file: ${{ inputs.dockerfile }}
          context: ${{ inputs.context }}
          push: true
          tags: ${{ env.tags_fixed }}
          build-args: ${{ inputs['build-args'] }}
          sbom: true
          provenance: mode=max

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Cosign sign image by digest (keyless OIDC)
        env:
          IMAGE_REF: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          DIGEST: ${{ steps.build.outputs.digest }}
        run: |
          set -euo pipefail
          echo "Signing $IMAGE_REF@$DIGEST"
          cosign sign --yes "$IMAGE_REF@$DIGEST"

      - name: Generate SLSA provenance attestation (GitHub)
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3.0.0
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          subject-digest: ${{ steps.build.outputs.digest }}

      - name: Export runtime image as OCI artifact
        env:
          OCI_EXPORT_PATH: build/oci/${{ env.IMAGE_NAME }}.tar
        run: |
          set -euo pipefail
          mkdir -p "$(dirname "$OCI_EXPORT_PATH")"

          ARGS=()
          if [[ -n "${BUILD_ARGS_RAW//[[:space:]]/}" ]]; then
            while IFS= read -r ARG; do
              [[ -z "$ARG" ]] && continue
              ARGS+=(--build-arg "$ARG")
            done <<< "$BUILD_ARGS_RAW"
          fi

          docker buildx build \
            --file "${{ inputs.dockerfile }}" \
            --platform linux/amd64 \
            --target runtime \
            --output type=oci,dest="$OCI_EXPORT_PATH" \
            "${ARGS[@]}" \
            "${{ inputs.context }}"

      - name: Upload OCI runtime artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.OCI_ARTIFACT_NAME }}
          path: build/oci/${{ env.IMAGE_NAME }}.tar
          if-no-files-found: error

      - name: Emit workflow outputs
        id: emit
        run: |
          echo "image_ref=${REGISTRY}/${IMAGE_NAME}" >> "$GITHUB_OUTPUT"
          echo "artifact_name=${OCI_ARTIFACT_NAME}" >> "$GITHUB_OUTPUT"
        env:
          REGISTRY: ${{ env.REGISTRY }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          OCI_ARTIFACT_NAME: ${{ env.OCI_ARTIFACT_NAME }}
